# MailCow AI Filter Configuration
# Local LLM Setup for mail.kekz.org

# Protocol: IMAP (recommended and working on your server)
protocol: "imap"

# IMAP Configuration
imap:
  server: "mail.kekz.org"
  username: "your-email@kekz.org"  # REPLACE with your actual email
  password: "your-password"         # REPLACE with your actual password
  use_ssl: true
  port: 993

# AI Configuration - Local LLM via Ollama
ai:
  provider: "ollama"

  # Current model: Qwen3 14B (fast, high quality)
  model: "qwen3:14b"

  # Other options:
  # model: "deepseek-r1:14b"  # Alternative model
  # model: "llama3.1:70b-instruct-q4_K_M"  # Larger, slower model

  base_url: "http://localhost:11434"

  # Analysis Modes (priority: embedding > hierarchical > simple)
  # Embedding mode: ML-based clustering (10-50x faster for 1000+ emails)
  use_embedding: true  # Enable embedding-based clustering (requires ML dependencies)

  # Two-Tier Hierarchical Mode (recommended for 100+ emails, fallback if embedding disabled)
  # Uses worker model to summarize each email, then master model for pattern analysis
  use_hierarchical: true  # Enable two-tier architecture

  # Worker model: Fast model for email summarization (parallel processing)
  worker_model: "gemma2:2b"  # Google's model with excellent JSON compliance

  # Master model: Better model for strategic pattern analysis
  master_model: "qwen3:14b"  # Master model for creating hierarchical folder structure

  # Analysis settings
  max_emails_to_analyze: 2000  # Analyze up to 2000 emails with embedding clustering
  max_parallel_workers: 3   # Reduced from 10 to avoid spamming Ollama
  sample_from_folders: true

  # AI Generation Settings (improved for better categorization)
  temperature: 0.7        # Increased from 0.5 for more creative categorization
  num_predict: 10000      # Required for BAAI model's detailed output (was 4000, then 6000)
  top_p: 0.9              # Nucleus sampling parameter

# Embedding & Clustering Configuration (NEW - improved ML performance)
embedding:
  # Embedding model for semantic similarity
  # Options: "all-MiniLM-L6-v2" (fast, 384-dim), "all-mpnet-base-v2" (balanced, 768-dim), "BAAI/bge-large-en-v1.5" (best quality, 1024-dim)
  model: "BAAI/bge-large-en-v1.5"  # PRODUCTION: Best quality (12.5% fewer outliers, better hierarchical structure)

clustering:
  # HDBSCAN clustering parameters
  min_cluster_size: 5     # Reduced from 8 - minimum emails to form a cluster
  min_samples: 2          # Reduced from 4 - more flexible clustering

  # Outlier handling
  handle_outliers: true   # Re-cluster outliers with lower thresholds
  outlier_min_cluster_size: 3  # Threshold for outlier re-clustering

# Email Analysis
analysis:
  # Folders to skip
  exclude_folders:
    - "Trash"
    - "Spam"
    - "Junk"
    - "Deleted Items"

  # Minimum emails in a category to generate a rule
  min_category_size: 5

  # Only analyze emails from last N months (default: 12)
  months_back: 12

# Sieve Rule Generation
sieve:
  output_file: "/app/output/generated.sieve"
  create_folders: true
  mark_as_read: false
  require_review: true

# Logging
logging:
  level: "DEBUG"  # Changed to DEBUG to see AI response details
  file: "/app/logs/ai-filter.log"
